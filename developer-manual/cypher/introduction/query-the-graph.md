### 3.1.2. 그래프 쿼리 및 업데이트

Cypher는 그래프를 쿼리하고 업데이트하는 데 사용할 수 있습니다.

#### 3.1.2.1. 업데이트 쿼리의 구조

- Cypher 쿼리 파트는 동시에 그래프를 일치시키고 업데이트 할 수 없습니다.
- 모든 파트는 그래프를 읽고 매치하거나 업데이트 할 수 있습니다.

그래프를 읽고 그래프를 업데이트하면 쿼리에 암묵적으로 두 부분이 있습니다. 첫 번째 부분은 읽기 부분이고 두 번째 부분은 쓰기입니다.

쿼리가 읽기만 수행하는 경우 Cypher는 게으르며 결과를 묻기 전까지 실제로 패턴과 일치하지 않습니다. 업데이트 쿼리에서 의미는 모든 기록이 실제로 발생하기 전에 완료된다는 것입니다.

쿼리 파트가 암시적으로 나타나는 유일한 패턴은 처음 읽었을 때와 쓰는 것입니다. 다른 모든 순서와 쿼리 파트를 명시해야합니다. 파트는 `WITH` 문을 사용하여 구분됩니다. `WITH`는 이벤트 지평선과 같습니다. 이는 계획과 해당 계획의 완료된 실행 사이의 장벽입니다.

집계 된 데이터를 사용하여 필터링하려면 두 개의 읽기 쿼리 파트를 연결해야 합니다. 첫 번째 쿼리는 집계를 수행하고 두 번째 쿼리는 첫 번째 쿼리에서 가져옵니다.

```Javascript
MATCH (n {name: 'John'})-[:FRIEND]-(friend)
WITH n, count(friend) AS friendsCount
WHERE friendsCount > 3
RETURN n, friendsCount
```

`WITH` 를 사용하여 집계를 수행하는 방법을 지정하고 Cypher가 필터링을 시작하기 전에 집계를 완료해야합니다.

다음은 그래프를 업데이트하고, 집계 된 데이터를 그래프에 쓰는 예입니다.

```Javascript
MATCH (n {name: 'John'})-[:FRIEND]-(friend)
WITH n, count(friend) AS friendsCount
SET n.friendCount = friendsCount
RETURN n.friendsCount
```
사용 가능한 메모리가 허용하는만큼 많은 쿼리 파트를 함께 연결할 수 있습니다.


#### 3.1.2.2. 데이터 반환

모든 쿼리는 데이터를 반환 할 수 있습니다. 쿼리가 읽는 경우에만 데이터를 반환해야합니다. 그렇지 않은 경우 아무런 도움이되지 않으며 유효한 Cypher 쿼리가 아닙니다. 그래프를 업데이트하는 쿼리는 아무 것도 반환 할 필요가 없지만 할 수는 있습니다.

쿼리의 모든 부분이 하나의 마지막 `RETURN` 절이됩니다. `RETURN`은 모든 쿼리 파트의 일부가 아니며 쿼리 끝의 마침표입니다. `RETURN` 절에는 `SKIP` / `LIMIT` 및 `ORDER BY` 와 같이 세 개의 하위 절이 있습니다.

방금 삭제 한 쿼리에서 그래프 요소를 반환하는 경우에는 더 이상 유효하지 않은 포인터가 있습니다. 해당 노드의 수행은 정의되지 않습니다.
